# Audio Transcription MCP - CPU Dockerfile
# Multi-stage build for smaller image size

# =============================================================================
# Stage 1: Builder
# =============================================================================
FROM python:3.11-slim AS builder

WORKDIR /app

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and build wheels
COPY requirements.txt .
RUN pip wheel --no-cache-dir --wheel-dir /wheels -r requirements.txt

# =============================================================================
# Stage 2: Runtime
# =============================================================================
FROM python:3.11-slim

LABEL maintainer="ebmarquez"
LABEL description="MCP server for audio transcription with speaker diarization"
LABEL version="0.1.0"

WORKDIR /app

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    libsndfile1 \
    curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copy wheels from builder and install
COPY --from=builder /wheels /wheels
RUN pip install --no-cache-dir /wheels/* && rm -rf /wheels

# Copy application code
COPY src/ ./src/
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Create directories for volume mounts
RUN mkdir -p /input /output /root/.cache/huggingface

# =============================================================================
# Environment Configuration
# =============================================================================
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Required
ENV HF_TOKEN=""

# Whisper configuration
ENV WHISPER_MODEL="large-v3"
ENV LANGUAGE="en"

# File processing
ENV MAX_FILE_SIZE_GB="1"
ENV INPUT_DIR="/input"
ENV OUTPUT_DIR="/output"

# MCP server
ENV MCP_TRANSPORT="streamable-http"
ENV MCP_PORT="8080"

# =============================================================================
# Health Check
# =============================================================================
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${MCP_PORT}/health || exit 1

# =============================================================================
# Expose & Run
# =============================================================================
EXPOSE 8080

ENTRYPOINT ["/entrypoint.sh"]
